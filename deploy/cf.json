{
  "Parameters": {
    "S3Key": {
      "Type": "String",
      "Description": "The S3 key that contains the deployment zip."
    },
    "DDApiKey": {
      "Type": "String",
      "Description": "Datadog API key."
    },
    "DDTags": {
      "Type": "String",
      "Description": "Additional Datadog Tags"
    },
    "GitVersion": {
      "Type": "String",
      "Description": "Current Git Id"
    }
  },
  "Resources": {
    "WalkscoreProxyRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": "WalkscoreProxyRole",
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "root",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": ["cloudfront:CreateInvalidation"],
                  "Resource": [
                    "arn:aws:cloudfront::473352343756:distribution/EH3F0Z8TUZVCQ",
                    "arn:aws:cloudfront::473352343756:distribution/ENTCATGUNQIQ"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "logs:CreateLogGroup",
                    "logs:CreateLogStream",
                    "logs:PutLogEvents"
                  ],
                  "Resource": ["*"]
                }
              ]
            }
          }
        ]
      }
    },
    "WalkscoreProxy": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "FunctionName": "WalkscoreProxy",
        "Role": {
          "Fn::GetAtt": ["WalkscoreProxyRole", "Arn"]
        },
        "Runtime": "python3.11",
        "MemorySize": 256,
        "Timeout": 900,
        "Handler": "lambda_function.lambda_handler",
        "Environment": {
          "Variables": {
            "DD_API_KEY": {
              "Ref": "DDApiKey"
            },
            "DD_VERSION": {
              "Ref": "GitVersion"
            },
            "DD_TAGS": {
              "Ref": "DDTags"
            },
            "DD_ENV": "prod",
            "DD_LAMBDA_HANDLER": "lambda_function.lambda_handler",
            "DD_SERVICE": "walkscore-proxy",
            "DD_SITE": "datadoghq.com",
            "DD_TRACE_ENABLED": "true"
          }
        },
        "Architectures": ["x86_64"],
        "Code": {
          "S3Bucket": "tm-walkscore-proxy-deploy",
          "S3Key": {
            "Ref": "S3Key"
          }
        }
      }
    }
  },
  "Transform": {
    "Name": "DatadogServerless",
    "Type": "AWS::Serverless-2016-10-31",
    "Parameters": {
      "stackName": {
        "Ref": "AWS::StackName"
      },
      "pythonLayerVersion": "83",
      "extensionLayerVersion": "51",
      "site": "datadoghq.com",
      "apiKey": {
        "Ref": "DDApiKey"
      }
    }
  }
}
